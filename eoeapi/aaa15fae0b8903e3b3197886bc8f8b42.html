{"title":"JNI Tips","text":"<p>\u8d1f\u8d23\u4eba\uff1a\u6714\u6708&amp;futurexiong \n<\/p><p>\u5206\u4efb\u52a1\u94fe\u63a5\u5730\u5740\uff1a<a rel=\"nofollow\" target=\"_blank\" class=\"external free\" href=\"http:\/\/docs.eoeandroid.com\/guide\/practices\/jni.html\">http:\/\/docs.eoeandroid.com\/guide\/practices\/jni.html<\/a> \n<\/p>\n<table id=\"toc\" class=\"toc\"><tr><td><div id=\"toctitle\"><h2>\u76ee\u5f55<\/h2><\/div>\n<ul>\n<li class=\"toclevel-1 tocsection-1\"><a href=\"#JNI_Tips-JNI.E6.8A.80.E5.B7.A7\"><span class=\"tocnumber\">1<\/span> <span class=\"toctext\">JNI Tips-JNI\u6280\u5de7<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-2\"><a href=\"#JavaVM_and_JNIEnv-JavaVM.E5.92.8CJNIEnv\"><span class=\"tocnumber\">2<\/span> <span class=\"toctext\">JavaVM and JNIEnv-JavaVM\u548cJNIEnv<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-3\"><a href=\"#Threads-.E7.BA.BF.E7.A8.8B\"><span class=\"tocnumber\">3<\/span> <span class=\"toctext\">Threads-\u7ebf\u7a0b<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-4\"><a href=\"#jclass.2C_jmethodID.2C_and_jfieldID\"><span class=\"tocnumber\">4<\/span> <span class=\"toctext\">jclass, jmethodID, and jfieldID<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-5\"><a href=\"#Exceptions-.E5.BC.82.E5.B8.B8.E5.A4.84.E7.90.86\"><span class=\"tocnumber\">5<\/span> <span class=\"toctext\">Exceptions-\u5f02\u5e38\u5904\u7406<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-6\"><a href=\"#Native_Libraries-.E6.9C.AC.E5.9C.B0.E5.BA.93\"><span class=\"tocnumber\">6<\/span> <span class=\"toctext\">Native Libraries-\u672c\u5730\u5e93<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-7\"><a href=\"#64-bit_Considerations-64-bit_.E7.8E.AF.E5.A2.83.E6.B3.A8.E6.84.8F.E4.BA.8B.E9.A1.B9\"><span class=\"tocnumber\">7<\/span> <span class=\"toctext\">64-bit Considerations-64-bit \u73af\u5883\u6ce8\u610f\u4e8b\u9879<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-8\"><a href=\"#Unsupported_Features.2FBackwards_Compatibility-.E4.B8.8D.E6.94.AF.E6.8C.81.E7.9A.84.E7.89.B9.E6.80.A7.2F.E5.90.91.E5.89.8D.E5.85.BC.E5.AE.B9.E6.80.A7\"><span class=\"tocnumber\">8<\/span> <span class=\"toctext\">Unsupported Features\/Backwards Compatibility-\u4e0d\u652f\u6301\u7684\u7279\u6027\/\u5411\u524d\u517c\u5bb9\u6027<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-9\"><a href=\"#FAQ:_Why_do_I_get_UnsatisfiedLinkError.3F-FAQ:_.E4.B8.BA.E4.BB.80.E4.B9.88.E6.88.91.E5.BE.97.E5.88.B0.E4.BA.86UnsatisfiedLinkError_.E9.94.99.E8.AF.AF.3F\"><span class=\"tocnumber\">9<\/span> <span class=\"toctext\">FAQ: Why do I get UnsatisfiedLinkError?-FAQ: \u4e3a\u4ec0\u4e48\u6211\u5f97\u5230\u4e86UnsatisfiedLinkError \u9519\u8bef?<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-10\"><a href=\"#FAQ:_Why_didn.27t_FindClass_find_my_class.3F-FAQ:_.E4.B8.BA.E4.BB.80.E4.B9.88.E6.88.91.E7.9A.84.E7.B1.BB.E6.96.87.E4.BB.B6.E4.B8.AD.E6.89.BE.E4.B8.8D.E5.88.B0FindClass.3F\"><span class=\"tocnumber\">10<\/span> <span class=\"toctext\">FAQ: Why didn't FindClass find my class?-FAQ: \u4e3a\u4ec0\u4e48\u6211\u7684\u7c7b\u6587\u4ef6\u4e2d\u627e\u4e0d\u5230FindClass?<\/span><\/a><\/li>\n<li class=\"toclevel-1 tocsection-11\"><a href=\"#FAQ:_How_do_I_share_raw_data_with_native_code.3F-FAQ:_.E6.88.91.E6.80.8E.E6.A0.B7.E6.89.8D.E8.83.BD.E4.B8.8E.E6.9C.AC.E5.9C.B0.E4.BB.A3.E7.A0.81.E5.85.B1.E4.BA.AB.E5.8E.9F.E5.A7.8B.E6.95.B0.E6.8D.AE.3F\"><span class=\"tocnumber\">11<\/span> <span class=\"toctext\">FAQ: How do I share raw data with native code?-FAQ: \u6211\u600e\u6837\u624d\u80fd\u4e0e\u672c\u5730\u4ee3\u7801\u5171\u4eab\u539f\u59cb\u6570\u636e?<\/span><\/a><\/li>\n<\/ul>\n<\/td><\/tr><\/table>\n<h2> <span class=\"mw-headline\" id=\"JNI_Tips-JNI.E6.8A.80.E5.B7.A7\">JNI Tips-JNI\u6280\u5de7<\/span><\/h2>\n<p>JNI\u662fJava\u672c\u5730\u63a5\u53e3(Java Native Interface)\u7684\u7b80\u79f0\u3002\u5b83\u5b9a\u4e49\u4e86\u6258\u7ba1\u4ee3\u7801(\u7528Java\u7f16\u7a0b\u8bed\u8a00\u5199\u7684)\u4e0e\u672c\u5730\u4ee3\u7801(\u7528C\/C++\u5199\u7684)\u4ea4\u4e92\u7684\u4e00\u79cd\u65b9\u5f0f(\u8bd1\u8005\u6ce8\uff1a\u8fd9\u91cc\u7684\u6258\u7ba1\u4ee3\u7801\u5e94\u8be5\u7406\u89e3\u6210\u53d7Java\u8fd0\u884c\u65f6\u73af\u5883\u76d1\u7ba1\u7684\u4ee3\u7801)\u3002\u5b83\u4e0e\u5382\u5546\u65e0\u5173\uff0c\u652f\u6301\u4ece\u52a8\u6001\u5171\u4eab\u5e93\u4e2d\u52a0\u8f7d\u4ee3\u7801\uff0c\u867d\u7136\u7e41\u7410\u4f46\u6709\u65f6\u662f\u5408\u7406\u6709\u6548\u7684\u3002\n<\/p><p>\u4f60\u5e94\u8be5\u901a\u8bfb<a rel=\"nofollow\" target=\"_blank\" class=\"external text\" href=\"http:\/\/java.sun.com\/javase\/6\/docs\/technotes\/guides\/jni\/spec\/jniTOC.html\">JNI spec for J2SE 6<\/a>\u6765\u83b7\u53d6\u5bf9JNI\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u4ee5\u53ca\u5b83\u6709\u4ec0\u4e48\u53ef\u7528\u7684\u529f\u80fd\u7684\u4e00\u4e2a\u8ba4\u77e5\u3002\u5728\u4f60\u8bfb\u7b2c\u4e00\u904d\u7684\u65f6\u5019\u53ef\u80fd\u5bf9JNI\u7684\u67d0\u4e9b\u65b9\u9762\u7684\u7406\u89e3\u4e0d\u4f1a\u7acb\u523b\u5c31\u6e05\u6670\uff0c\u6240\u4ee5\u4f60\u4f1a\u53d1\u73b0\u4e00\u4e0b\u7684\u7ae0\u8282\u53ef\u80fd\u4f1a\u5bf9\u4f60\u6709\u6240\u5e2e\u52a9\u3002<a rel=\"nofollow\" target=\"_blank\" class=\"external text\" href=\"http:\/\/java.sun.com\/docs\/books\/jni\/html\/jniTOC.html\">JNI Programmer's Guide and Specification<\/a>\u91cc\u6709\u66f4\u4e3a\u8be6\u7ec6\u7684\u8d44\u6599\u3002\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"JavaVM_and_JNIEnv-JavaVM.E5.92.8CJNIEnv\">JavaVM and JNIEnv-JavaVM\u548cJNIEnv<\/span><\/h2>\n<p>JNI\u5b9a\u4e49\u4e862\u79cd\u5173\u952e\u7684\u6570\u636e\u7ed3\u6784\uff0c\"JavaVM\"\u548c\"JNIEnv\"\u3002\u5b83\u4eec\u672c\u8d28\u4e0a\u90fd\u662f\u6307\u5411\u51fd\u6570\u8868\u7684\u6307\u9488\u7684\u6307\u9488\u3002(\u5728C++\u7684\u7248\u672c\u4e2d\uff0c\u5b83\u4eec\u88ab\u5b9a\u4e49\u6210\u7c7b(\u8bd1\u8005\u6ce8:\u51c6\u786e\u6765\u8bf4\u662fC++\u4e2d\u7684\u7ed3\u6784\u4f53)\uff0c\u7c7b\u91cc\u9762\u5305\u542b\u4e00\u4e2a\u6307\u5411\u51fd\u6570\u8868\u7684\u6307\u9488\uff0c\u4ee5\u53ca\u4e0eJNI\u51fd\u6570\u4e00\u4e00\u5bf9\u5e94\u7684\u7528\u6765\u95f4\u63a5\u8bbf\u95ee\u51fd\u6570\u8868\u7684\u6210\u5458\u51fd\u6570\u3002)JavaVM\u63d0\u4f9b\u4e86\"\u8c03\u7528\u63a5\u53e3\"\u7684\u51fd\u6570\uff0c\u5141\u8bb8\u4f60\u521b\u5efa\u548c\u9500\u6bc1\u4e00\u4e2aJavaVM\u3002\u7406\u8bba\u4e0a\u6bcf\u4e2a\u8fdb\u7a0b\u4f60\u53ef\u4ee5\u6709\u591a\u4e2aJavaVM\uff0c\u4f46Android\u53ea\u5141\u8bb8\u6709\u4e00\u4e2a\u3002\n<\/p><p>JNIEnv\u63d0\u4f9b\u4e86\u5927\u591a\u6570\u7684JNI\u51fd\u6570\u3002\u4f60\u7684\u672c\u5730\u65b9\u6cd5\u90fd\u4f1a\u63a5\u6536JNIEnv\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\u3002 \n<\/p><p>JNIEnv\u7528\u4e8e\u672c\u5730\u7ebf\u7a0b\u5b58\u50a8\u3002\u56e0\u6b64\uff0c\u4f60\u4e0d\u80fd\u5728\u7ebf\u7a0b\u95f4\u5171\u4eab\u540c\u4e00\u4e2aJNIEnv\u3002\u5982\u679c\u4e00\u4e2a\u4ee3\u7801\u6bb5\u6ca1\u6709\u5176\u4ed6\u65b9\u5f0f\u83b7\u53d6\u5b83\u81ea\u8eab\u7ebf\u7a0b\u7684JNIEnv\uff0c\u4f60\u53ef\u4ee5\u5171\u4eabJavaVM\uff0c\u7528GetEnv\u6765\u83b7\u53d6\u7ebf\u7a0b\u7684JNIEnv\u3002(\u5047\u8bbe\u8fd9\u4e2a\u7ebf\u7a0b\u6709\u4e00\u4e2aJavaVM;\u53c2\u89c1\u4e0b\u9762\u7684AttachCurrentThread\u3002)\n<\/p><p>C\u7248\u672c\u7684JNIEnv\u548cJavaVM\u7684\u58f0\u660e\u662f\u5f02\u4e8eC++\u7248\u672c\u7684\u3002\"jni.h\"\u5934\u6587\u4ef6\u6839\u636e\u88ab\u5305\u542b\u5728C\u6216\u662fC++\u6587\u4ef6\u4e2d\u6765\u63d0\u4f9b\u4e0d\u540c\u7c7b\u578b\u7684typedefs\u3002\u56e0\u6b64\u5728\u88ab\u4e24\u79cd\u8bed\u8a00\u5305\u542b\u7684\u5934\u6587\u4ef6\u4e2d\u5305\u542bJNIEnv\u53c2\u6570\u4e0d\u662f\u660e\u667a\u7684\u9009\u62e9\u3002(\u6362\u53e5\u8bdd\u8bf4:\u5982\u679c\u4f60\u7684\u5934\u6587\u4ef6\u4e2d\u9700\u8981\u7528\u5230#ifdef __cplusplus,\u90a3\u4e48\u5728\u6709\u6d89\u53ca\u5230JNIEnv\u7684\u5185\u5bb9\u7684\u65f6\u5019\u4f60\u9700\u8981\u505a\u4e00\u4e9b\u989d\u5916\u7684\u5de5\u4f5c\u3002)\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"Threads-.E7.BA.BF.E7.A8.8B\">Threads-\u7ebf\u7a0b<\/span><\/h2>\n<p>\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u662fLinux\u7684\u7ebf\u7a0b\uff0c\u7531\u5185\u6838\u8c03\u5ea6\u3002\u5b83\u4eec\u901a\u5e38\u7531\u6258\u7ba1\u4ee3\u7801\u542f\u52a8(\u4f7f\u7528Thread.start)\uff0c\u4f46\u662f\u4e5f\u53ef\u4ee5\u5728\u522b\u7684\u5730\u65b9\u521b\u5efa\u5b83\u4eec\uff0c\u5e76\u628a\u5b83\u4eec\u8fde\u63a5\u5230JavaVM\u4e0a\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a\u7531pthread_create\u65b9\u6cd5\u542f\u52a8\u7684\u7ebf\u7a0b\u53ef\u4ee5\u7528JNI\u7684AttachCurrentThread\u6216\u8005AttachCurrentThreadAsDaemon\u51fd\u6570\u6765\u8fde\u63a5\u3002\u5728\u7ebf\u7a0b\u6ca1\u6709\u88ab\u8fde\u63a5\u5230JavaVM\u4e4b\u524d\u662f\u4e0d\u4f1a\u6709JNIEnv\u7684\uff0c\u4e5f\u65e0\u6cd5\u53d1\u8d77JNI\u7684\u8c03\u7528\u3002\n<\/p><p>\u8fde\u63a5\u4e00\u4e2a\u672c\u5730\u521b\u5efa\u7684\u7ebf\u7a0b\u4f1a\u6784\u9020\u4e00\u4e2ajava.lang.Thread\u7684\u5bf9\u8c61\uff0c\u5e76\u628a\u8fd9\u4e2a\u5bf9\u8c61\u6dfb\u52a0\u5230\"\u4e3b\"\u7ebf\u7a0b\u7ec4\u91cc\u9762\uff0c\u4f7f\u4e4b\u5bf9\u8c03\u8bd5\u8005\u53ef\u89c1\u3002\u5bf9\u4e00\u4e2a\u5df2\u88ab\u8fde\u63a5\u7684\u7ebf\u7a0b\u8c03\u7528AttachCurrentThread\u4e0d\u505a\u4efb\u4f55\u64cd\u4f5c\u3002\n<\/p><p>Android\u4e0d\u4f1a\u6682\u505c\u6b63\u5728\u6267\u884c\u672c\u5730\u4ee3\u7801\u7684\u7ebf\u7a0b\u3002\u5982\u679c\u5783\u573e\u6536\u96c6\u5668\u6b63\u5728\u8fd0\u884c\uff0c\u6216\u8005\u662f\u8c03\u8bd5\u8005\u53d1\u51fa\u4e86\u6682\u505c\u7684\u8bf7\u6c42\uff0cAndroid\u4f1a\u5728\u5b83\u53d1\u8d77\u4e0b\u4e00\u4e2aJNI\u8c03\u7528\u7684\u65f6\u5019\u6682\u505c\u7ebf\u7a0b\u3002\n<\/p><p>\u901a\u8fc7JNI\u8fde\u63a5\u7684\u7ebf\u7a0b\u5728\u5b83\u4eec\u9000\u51fa\u4e4b\u524d\u5fc5\u987b\u8c03\u7528DetachCurrentThread\u65b9\u6cd5\u3002\u5982\u679c\u76f4\u63a5\u7f16\u5199\u8fd9\u6837\u7684\u8c03\u7528\u4ee3\u7801\u4f1a\u663e\u5f97\u5f88\u7b28\u62d9\uff0c\u5728Android2.0(Eclair)\u53ca\u66f4\u9ad8\u7684\u7248\u672c\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528pthread_key_create\u6765\u5b9a\u4e49\u4e00\u4e2a\u6790\u6784\u51fd\u6570\uff0c\u5e76\u5728\u6790\u6784\u51fd\u6570\u91cc\u8c03\u7528DetachCurrentThread\u65b9\u6cd5\uff0c\u6790\u6784\u51fd\u6570\u4f1a\u5728\u7ebf\u7a0b\u9000\u51fa\u4e4b\u524d\u88ab\u8c03\u7528\u3002\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"jclass.2C_jmethodID.2C_and_jfieldID\">jclass, jmethodID, and jfieldID<\/span><\/h2>\n<p>\u5982\u679c\u4f60\u60f3\u5728\u672c\u5730\u4ee3\u7801\u4e2d\u8bbf\u95ee\u4e00\u4e2a\u5bf9\u8c61\u7684\u5b57\u6bb5\uff0c\u4f60\u5c06\u4f1a\u505a\u4ee5\u4e0b\u4e8b\u60c5:\n<\/p>\n<ul><li>\u53d6\u5f97FindClass\u5f97\u5230\u7684\u7c7b\u7684\u7c7b\u5bf9\u8c61\u5f15\u7528\n<\/li><li>\u53d6\u5f97GetFieldID\u5f97\u5230\u7684\u5b57\u6bb5\u7684\u5b57\u6bb5ID\n<\/li><li>\u7528\u5408\u9002\u7684\u65b9\u6cd5\u53d6\u5f97\u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u6bd4\u5982GetIntField\n<\/li><\/ul>\n<p>\u540c\u6837\u7684\uff0c\u8981\u8c03\u7528\u4e00\u4e2a\u65b9\u6cd5\uff0c\u4f60\u5fc5\u987b\u5148\u5f97\u5230\u4e00\u4e2a\u7c7b\u5bf9\u8c61\u7684\u5f15\u7528\u548c\u65b9\u6cd5ID\u3002\u8fd9\u4e9bID\u901a\u5e38\u6765\u8bf4\u53ea\u662f\u6307\u5411\u5185\u90e8\u7684\u8fd0\u884c\u65f6\u6570\u636e\u7ed3\u6784\u3002\u627e\u5230\u5b83\u4eec\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u5b57\u7b26\u4e32\u7684\u6bd4\u8f83\uff0c\u4f46\u4e00\u65e6\u4f60\u5f97\u5230\u5b83\u4eec\u4e4b\u540e\u5b9e\u9645\u7684\u5b57\u6bb5\u53d6\u503c\u6216\u8005\u65b9\u6cd5\u8c03\u7528\u5c06\u4f1a\u975e\u5e38\u7684\u5feb\u3002\n<\/p><p><br \/>\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"Exceptions-.E5.BC.82.E5.B8.B8.E5.A4.84.E7.90.86\">Exceptions-\u5f02\u5e38\u5904\u7406<\/span><\/h2>\n<p>You must not call most JNI functions while an exception is pending. Your code is expected to notice the exception (via the function's return value, ExceptionCheck, or ExceptionOccurred) and return, or clear the exception and handle it.\n<\/p><p>\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5f53\u7a0b\u5e8f\u53d1\u751f\u5f02\u5e38\u7684\u65f6\u5019\u4f60\u662f\u65e0\u6cd5\u8c03\u7528JNI\u6a21\u5757\u7684\u3002\u56e0\u4e3a\u4f60\u7684\u4ee3\u7801\u4e0d\u4f46\u9700\u8981\u6807\u8bb0\u51fa\u5f02\u5e38\u51fa\u73b0\u7684\u4f4d\u7f6e\uff08\u53ef\u4ee5\u901a\u8fc7ExceptionCheck\u6216\u8005ExceptionOccurred\u7684\u8fd4\u56de\u503c\uff09\uff0c\u800c\u4e14\u9700\u8981\u5bf9\u8fd9\u4e9b\u6240\u629b\u51fa\u7684\u5f02\u5e38\u8fdb\u884c\u5904\u7406\u3002\n<\/p><p>The only JNI functions that you are allowed to call while an exception is pending are:\n<\/p><p>\u4ec5\u5728\u4ee5\u4e0b\u5f02\u5e38\u88ab\u629b\u51fa\u65f6\uff0c\u4f60\u53ef\u4ee5\u8c03\u7528JNI\u51fd\u6570\uff1a\n<\/p>\n<ul><li>DeleteGlobalRef\n<\/li><li>DeleteLocalRef\n<\/li><li>DeleteWeakGlobalRef \n<\/li><li>ExceptionCheck \n<\/li><li>ExceptionClear\n<\/li><li>ExceptionDescribe\n<\/li><li>ExceptionOccurred \n<\/li><li>MonitorExit\n<\/li><li>PopLocalFrame \n<\/li><li>PushLocalFrame\n<\/li><li>Release&lt;PrimitiveType&gt;ArrayElements\n<\/li><li>ReleasePrimitiveArrayCritical\n<\/li><li>ReleaseStringChars\n<\/li><li>ReleaseStringCritical\n<\/li><li>ReleaseStringUTFChars \n<\/li><\/ul>\n<p>Many JNI calls can throw an exception, but often provide a simpler way of checking for failure. For example, if NewString returns a non-NULL value, you don't need to check for an exception. However, if you call a method (using a function like CallObjectMethod), you must always check for an exception, because the return value is not going to be valid if an exception was thrown.\n<\/p><p>\u591a\u6570JNI\u5728\u88ab\u8c03\u7528\u65f6\u80fd\u591f\u629b\u51fa\u4e00\u4e2a\u5f02\u5e38\uff0c\u4f46\u901a\u5e38\u8fd8\u6709\u4e00\u79cd\u66f4\u7b80\u5355\u7684\u65b9\u5f0f\u6765\u68c0\u9a8c\u8be5\u8c03\u7528\u662f\u5426\u51fa\u73b0\u5931\u6548\u3002\u6bd4\u5982\u8bf4\uff0c\u5982\u679c\u8c03\u7528NewString\u65b9\u6cd5\u8fd4\u56de\u4e00\u4e2a\u975enull\u503c\uff0c\u90a3\u4e48\u4f60\u5c31\u4e0d\u9700\u8981\u518d\u5bf9\u5176\u8fdb\u884c\u5f02\u5e38\u68c0\u67e5\u3002\u4f46\u5982\u679c\u4f60\u8c03\u7528\u7684\u662f\u4e00\u4e2a\u7c7b\u4f3cCallObjectMethod\u8fd9\u6837\u7684\u51fd\u6570\u65f6\uff0c\u4f60\u8fd8\u662f\u5fc5\u987b\u505a\u5f02\u5e38\u7684\u68c0\u67e5\u5904\u7406\uff0c\u8fd9\u662f\u56e0\u4e3a\u5f53\u51fa\u73b0\u5f02\u5e38\u65f6\uff0c\u8c03\u7528\u8be5\u6a21\u5757\u5e76\u4e0d\u4f1a\u8fd4\u56de\u4e00\u4e2a\u6709\u6548\u503c\u3002\n<\/p><p>Note that exceptions thrown by interpreted code do not unwind native stack frames, and Android does not yet support C++ exceptions. The JNI Throw and ThrowNew instructions just set an exception pointer in the current thread. Upon returning to managed from native code, the exception will be noted and handled appropriately.\n<\/p><p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u7ffb\u8bd1\u7801\u629b\u51fa\u7684\u5f02\u5e38\u5e76\u4e0d\u4f1a\u91ca\u653e\u5806\u6808\u5e27\u7a7a\u95f4\uff0c\u4e14\u76ee\u524d\u7684Android\u7cfb\u7edf\u4e5f\u4e0d\u652f\u6301C++\u5f02\u5e38\u5904\u7406\u3002\u6240\u4ee5JNI\u7684Throw\u548cThrowNew\u6307\u4ee4\u4ec5\u4ec5\u53ea\u662f\u5728\u5f53\u524d\u7684\u7ebf\u7a0b\u4e2d\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u5f02\u5e38\u5904\u7406\u6307\u9488\uff0c\u800c\u5f53\u4ece\u672c\u5730\u4ee3\u7801\u8fd4\u56de\u6258\u7ba1\u4ee3\u7801\u65f6\uff0c\u8be5\u5f02\u5e38\u624d\u80fd\u88ab\u6807\u6ce8\u5e76\u5f97\u5230\u6709\u6548\u7684\u5904\u7406\u3002\n<\/p><p>Native code can \"catch\" an exception by calling ExceptionCheck or ExceptionOccurred, and clear it with ExceptionClear. As usual, discarding exceptions without handling them can lead to problems.\n<\/p><p>\u5f53\u7136\uff0c\u672c\u5730\u4ee3\u7801\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528ExceptionCheck\u6216\u8005 ExceptionOccurred\u51fd\u6570\u6765\u6355\u83b7\u76f8\u5e94\u7684\u5f02\u5e38\uff0c\u4e5f\u80fd\u901a\u8fc7\u8c03\u7528ExceptionClear\u51fd\u6570\u6765\u6e05\u7406\u8be5\u5f02\u5e38\u3002\u540c\u6837\uff0c\u5982\u679c\u5bf9\u629b\u51fa\u7684\u5f02\u5e38\u4e0d\u4f5c\u5904\u7406\u4e5f\u4f1a\u9020\u6210\u95ee\u9898\u3002\n<\/p><p>There are no built-in functions for manipulating the Throwable object itself, so if you want to (say) get the exception string you will need to find the Throwable class, look up the method ID for getMessage \"()Ljava\/lang\/String;\", invoke it, and if the result is non-NULL use GetStringUTFChars to get something you can hand to printf(3) or equivalent.\n<\/p><p>\u7531\u4e8e\u5bf9Throwable\u5bf9\u8c61\u7684\u64cd\u4f5c\u4e0d\u652f\u6301\u5185\u7f6e\u51fd\u6570\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u9700\u8981\u83b7\u53d6\u76f8\u5e94\u7684\u5f02\u5e38\u5b57\u7b26\u4e32\uff0c\u4f60\u9996\u5148\u9700\u8981\u627e\u5230Throwable\u7c7b\uff0c\u7136\u540e\u627e\u5230getMessage \"()Ljava\/lang\/String;\u201d\u65b9\u6cd5\u7684ID\uff0c\u8c03\u7528\u5b83\uff0c\u5047\u5982\u8c03\u7528\u540e\u8fd4\u56de\u7684\u7ed3\u679c\u662f\u975enull\u503c\uff0c\u5219\u9700\u8981\u901a\u8fc7GetStringUTFChars\u65b9\u6cd5\u6765\u628a\u83b7\u53d6\u7684\u7ed3\u679c\u4f20\u7ed9printf(3)\u6216\u8005\u662f\u91c7\u7528\u5176\u4ed6\u7c7b\u4f3c\u7684\u65b9\u6cd5\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\u3002\n<\/p><p>JNI does very little error checking. Errors usually result in a crash. Android also offers a mode called CheckJNI, where the JavaVM and JNIEnv function table pointers are switched to tables of functions that perform an extended series of checks before calling the standard implementation.\n<\/p><p>JNI\u5f88\u5c11\u5bf9\u9519\u8bef\u8fdb\u884c\u68c0\u67e5\u3002\u800c\u9519\u8bef\u5e38\u4f1a\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u3002Android\u4e3a\u6b64\u63d0\u4f9b\u4e86\u4e00\u79cdCheckJNI\u5904\u7406\u6a21\u5f0f\uff0c\u5f53JAVA\u865a\u62df\u673a\u4ee5\u53caJNIEnv\u51fd\u6570\u8868\u6307\u9488\u88ab\u5207\u6362\u5230\u51fd\u6570\u5217\u8868\u65f6\uff0c\u8be5\u6a21\u5f0f\u4f1a\u5728\u8c03\u7528\u6807\u51c6\u5b9e\u73b0\u4e4b\u524d\u505a\u51fa\u4e00\u7cfb\u5217\u7684\u9644\u52a0\u68c0\u67e5\u63aa\u65bd\u3002\n<\/p><p>The additional checks include:\n<\/p><p>\u9644\u52a0\u7684\u68c0\u67e5\u5305\u62ec\uff1a\n<\/p>\n<ul><li>Arrays: attempting to allocate a negative-sized array.\n<\/li><li>\u6570\u7ec4\uff1a\u5c1d\u8bd5\u5206\u914d\u4e00\u4e2a\u957f\u5ea6\u5927\u5c0f\u4e3a\u8d1f\u6570\u7684\u6570\u7ec4\u3002\n<\/li><\/ul>\n<ul><li>Bad pointers: passing a bad jarray\/jclass\/jobject\/jstring to a JNI call, or passing a NULL pointer to a JNI call with a non-nullable argument.\n<\/li><li>\u574f\u6307\u9488\uff1a\u5c06\u4e00\u4e2a\u9519\u8bef\u7684jarray\/jclass\/jobject\/jstring\u4f20\u9012\u7ed9JNI\u8c03\u7528\uff0c\u6216\u8005\u662f\u5e26\u4e00\u4e2a\u975e\u7a7a\u53c2\u6570\u5c06\u7a7a\u6307\u9488\u4f20\u9012\u7ed9JNI\u8c03\u7528\u3002\n<\/li><\/ul>\n<ul><li>Class names: passing anything but the \u201cjava\/lang\/String\u201d style of class name to a JNI call.\n<\/li><li>\u7c7b\u540d\u79f0\uff1aJNI\u8c03\u7528\u65f6\u672a\u91c7\u7528\u7c7b\u4f3c\u4e8e\u201cjava\/lang\/String\u201d\u8fd9\u79cd\u683c\u5f0f\u7684\u7c7b\u540d\u3002\n<\/li><\/ul>\n<ul><li>Critical calls: making a JNI call between a \u201ccritical\u201d get and its corresponding release.\n<\/li><li>\u4e34\u754c\u8c03\u7528\uff1a\u5728\u201c\u4e34\u754c\u533a\u201d\u83b7\u53d6\u6216\u8005\u91ca\u653e\u7684\u65f6\u5019\u8fdb\u884cJNI\u8c03\u7528\u64cd\u4f5c\u3002\n<\/li><\/ul>\n<ul><li>Direct ByteBuffers: passing bad arguments to NewDirectByteBuffer.\n<\/li><li>\u76f4\u63a5ByteBuffers\uff1a\u5c06\u9519\u8bef\u7684\u53c2\u6570\u4f20\u9012\u7ed9NewDirectByteBuffer\u51fd\u6570\u3002\n<\/li><\/ul>\n<ul><li>Exceptions: making a JNI call while there\u2019s an exception pending.\n<\/li><li>\u5f02\u5e38\uff1a\u5f53\u53d1\u751f\u5f02\u5e38\u65f6\u8fdb\u884cJNI\u8c03\u7528\u3002\n<\/li><\/ul>\n<ul><li>JNIEnv*s: using a JNIEnv* from the wrong thread.\n<\/li><li>JNIEnv*s: \u5728\u9519\u8bef\u7684\u7ebf\u7a0b\u4e2d\u4f7f\u7528JNIEnv\u6307\u9488\u3002\n<\/li><\/ul>\n<ul><li>jfieldIDs: using a NULL jfieldID, or using a jfieldID to set a field to a value of the wrong type (trying to assign a StringBuilder to a String field, say), or using a jfieldID for a static field to set an instance field or vice versa, or using a jfieldID from one class with instances of another class.\n<\/li><li>jfieldIDs\uff1a\u4f7f\u7528\u7a7a\u7684jfieldID\uff0c\u6216\u662f\u901a\u8fc7jfieldID\u8bbe\u7f6e\u53d8\u91cf\u503c\u65f6\u6307\u5b9a\u4e86\u9519\u8bef\u7684\u7c7b\u578b\uff08\u6bd4\u5982\u8bf4\u5c1d\u8bd5\u5c06\u4e00\u4e2aString\u578b\u53d8\u91cf\u8bbe\u7f6e\u4e3aStringBuilder\u7c7b\u578b\uff09\uff0c\u53c8\u6216\u8005\u662f\u901a\u8fc7jfieldID\u5c06\u4e00\u4e2a\u9759\u6001\u53d8\u91cf\u8bbe\u7f6e\u4e3a\u5b9e\u4f8b\u53d8\u91cf\uff0c\u53cd\u4e4b\u4ea6\u7136\uff0c\u8fd8\u6709\u53ef\u80fd\u662f\uff0c\u901a\u8fc7jfieldID\u5c06\u4e00\u4e2a\u7c7b\u7684\u5bf9\u8c61\u6307\u5b9a\u4e3a\u53e6\u5916\u4e00\u4e2a\u7c7b\u7684\u5bf9\u8c61\u3002\n<\/li><\/ul>\n<ul><li>jmethodIDs: using the wrong kind of jmethodID when making a Call*Method JNI call: incorrect return type, static\/non-static mismatch, wrong type for \u2018this\u2019 (for non-static calls) or wrong class (for static calls).\n<\/li><li>jmethodIDs\uff1a\u8fd0\u7528Call*Method\u7684JNI\u8c03\u7528\u65f6\uff0cjmethodID\u65b9\u6cd5\u8fd0\u7528\u9519\u8bef\uff1a\u8fd4\u56de\u9519\u8bef\u7684\u7c7b\u578b\u503c\uff0c\u9759\u6001\/\u975e\u9759\u6001\u5339\u914d\u9519\u8bef\uff0c\u2018this\u2019\u7c7b\u578b\u9519\u8bef\uff08\u5f53\u4f7f\u7528\u975e\u9759\u6001\u8c03\u7528\u65f6\uff09\u4ee5\u53ca\u9519\u8bef\u7684\u7c7b\u5b9a\u4e49\uff08\u4f7f\u7528\u9759\u6001\u8c03\u7528\u65f6\uff09\u3002\n<\/li><\/ul>\n<ul><li>References: using DeleteGlobalRef\/DeleteLocalRef on the wrong kind of reference.\n<\/li><li>\u5f15\u7528\uff1a\u8c03\u7528DeleteGlobalRef\/DeleteLocalRef\u51fd\u6570\u65f6\u4f7f\u7528\u4e86\u9519\u8bef\u7684\u5f15\u7528\u3002\n<\/li><\/ul>\n<ul><li>Release modes: passing a bad release mode to a release call (something other than 0, JNI_ABORT, or JNI_COMMIT).\n<\/li><li>Release\u6a21\u5f0f\uff1a\u8fdb\u884crelease\u8c03\u7528\u65f6\u4f7f\u7528\u4e86\u9519\u8bef\u7684release\u6a21\u5f0f\uff08\u5373\u9009\u62e90\uff0cJNI_ABORT \u6216\u8005JNI_COMMIT\u4ee5\u5916\u7684\u503c\uff09\n<\/li><\/ul>\n<ul><li>Type safety: returning an incompatible type from your native method (returning a StringBuilder from a method declared to return a String, say).\n<\/li><li>\u7c7b\u578b\u5b89\u5168\uff1a\u4ece\u4f60\u7684\u672c\u5730\u65b9\u6cd5\u4e2d\u8fd4\u56de\u4e86\u4e00\u4e2a\u4e0d\u5339\u914d\u7684\u7c7b\u578b\u503c\uff08\u6bd4\u5982\u4ece\u4e00\u4e2a\u58f0\u660e\u4e3aString\u4f5c\u4e3a\u8fd4\u56de\u503c\u7684\u65b9\u6cd5\u4e2d\u8fd4\u56de\u4e00\u4e2aStringBuilder\u7c7b\u578b\u7684\u8fd4\u56de\u503c\uff09\n<\/li><\/ul>\n<ul><li>UTF-8: passing an invalid Modified UTF-8 byte sequence to a JNI call.\n<\/li><li>UTF-8\u7f16\u7801\uff1a\u5c06\u4e00\u4e2a\u65e0\u6548\u7684Modified UTF-8\u5b57\u8282\u4e32\u4f20\u9012\u7ed9JNI\u8c03\u7528\u3002\n<\/li><\/ul>\n<p>(Accessibility of methods and fields is still not checked: access restrictions don't apply to native code.)\n(\u53ef\u8bbf\u95ee\u7684\u65b9\u6cd5\u548c\u53d8\u91cf\u5728\u6b64\u5e76\u6ca1\u6709\u88ab\u68c0\u67e5\uff1a\u8fd9\u662f\u56e0\u4e3a\u8bbf\u95ee\u9650\u5236\u5e76\u4e0d\u9002\u7528\u4e8e\u672c\u5730\u4ee3\u7801\uff09\n<\/p><p>There are several ways to enable CheckJNI.\n\u4e0b\u5217\u65b9\u6cd5\u53ef\u4ee5\u7528\u6765\u4f7f\u80fdCheckJNI\u6a21\u5f0f\u3002\n<\/p><p>If you\u2019re using the emulator, CheckJNI is on by default.\n\u5982\u679c\u4f60\u7528\u7684\u662f\u6a21\u62df\u5668\uff0c\u90a3\u4e48CheckJNI\u6a21\u5f0f\u9ed8\u8ba4\u5df2\u7ecf\u88ab\u5f00\u542f\u3002\n<\/p><p>If you have a rooted device, you can use the following sequence of commands to restart the runtime with CheckJNI enabled:\n\u5982\u679c\u4f60\u7684\u8bbe\u5907\u5df2\u7ecf\u83b7\u53d6root\u6743\u9650\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u7684\u547d\u4ee4\u884c\u6765\u91cd\u65b0\u542f\u52a8\u8fd0\u884c\u8bbe\u5907\uff0c\u4f7f\u80fdCheckJNI\u6a21\u5f0f\uff1a\n<\/p>\n<pre>\nadb shell stop\nadb shell setprop dalvik.vm.checkjni true\nadb shell start\n<\/pre>\n<p>In either of these cases, you\u2019ll see something like this in your logcat output when the runtime starts:\n\u7136\u540e\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u8bbe\u5907\u542f\u52a8\u8fd0\u884c\u9636\u6bb5\u65f6\u6253\u5370\u7684logcat\u4fe1\u606f\u6765\u786e\u8ba4\u662f\u5426\u5f00\u542f\u8be5\u6a21\u5f0f\u3002\n<\/p>\n<pre>\nD AndroidRuntime: CheckJNI is ON\n<\/pre>\n<p>If you have a regular device, you can use the following command:\n\u5982\u679c\u4f60\u624b\u91cc\u7684\u673a\u5668\u53ea\u662f\u666e\u901a\u53d1\u884c\u7248\u672c\uff0c\u4f60\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u7684\u547d\u4ee4\u884c\u6765\u5f00\u542f\u6a21\u5f0f\uff1a\n<\/p>\n<pre>\nadb shell setprop debug.checkjni 1\n<\/pre>\n<p>This won\u2019t affect already-running apps, but any app launched from that point on will have CheckJNI enabled. (Change the property to any other value or simply rebooting will disable CheckJNI again.) In this case, you\u2019ll see something like this in your logcat output the next time an app starts:\n<\/p><p>\u8be5\u65b9\u6cd5\u4e0d\u4f1a\u5bf9\u5df2\u7ecf\u8fd0\u884c\u7684\u5e94\u7528\u8f6f\u4ef6\u8d77\u4f5c\u7528\uff0c\u53ea\u80fd\u4f7f\u4e4b\u540e\u542f\u52a8\u7684\u5e94\u7528\u8f6f\u4ef6\u5e26\u6709CheckJNI\u6a21\u5f0f\u3002\uff08\u5982\u679c\u5c06property\u53c2\u6570\u503c\u4f5c\u4efb\u610f\u4fee\u6539\u6216\u8005\u662f\u91cd\u542f\u7cfb\u7edf\u90fd\u5c31\u80fd\u91cd\u65b0\u7981\u7528CheckJNI\u6a21\u5f0f\uff09\u3002\u5982\u679c\u4f60\u91c7\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u90a3\u4e48\u5f53\u4efb\u4f55\u4e00\u4e2a\u5e94\u7528\u8f6f\u4ef6\u542f\u52a8\u65f6\uff0c\u4f60\u90fd\u4f1a\u5728logcat\u7684\u8f93\u51fa\u7a97\u53e3\u770b\u5230\u5982\u4e0b\u7684\u4fe1\u606f\uff1a\n<\/p>\n<pre>\nD Late-enabling CheckJNI\n<\/pre>\n<h2> <span class=\"mw-headline\" id=\"Native_Libraries-.E6.9C.AC.E5.9C.B0.E5.BA.93\">Native Libraries-\u672c\u5730\u5e93<\/span><\/h2>\n<p>You can load native code from shared libraries with the standard System.loadLibrary call. The preferred way to get at your native code is:\n\u4f60\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684System.loadLibrary\u8c03\u7528\u4ece\u5171\u4eab\u5e93\u4e2d\u8f7d\u5165\u672c\u5730\u4ee3\u7801\u3002\u4f46\u4f60\u8fd8\u6709\u66f4\u597d\u7684\u6e20\u9053\u6765\u83b7\u53d6\u672c\u5730\u4ee3\u7801\uff0c\u65b9\u6cd5\u5982\u4e0b\uff1a\n<\/p>\n<ul><li>Call System.loadLibrary from a static class initializer. (See the earlier example, where one is used to call nativeClassInit.) The argument is the \"undecorated\" library name, so to load \"libfubar.so\" you would pass in \"fubar\".\n<\/li><li>\u5728\u9759\u6001\u7c7b\u7684\u521d\u59cb\u5316\u65f6\u8c03\u7528System.loadLibrary\u3002\uff08\u53ef\u4ee5\u53c2\u8003\u4e4b\u524d\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982\u8c03\u7528nativeClassInit\u51fd\u6570\u65f6\uff09\u3002\u5c06\u201c\u539f\u59cb\u201d\u7684\u5e93\u540d\u4f5c\u4e3a\u53c2\u6570\uff0c\u4f60\u5c06\u5176\u4f20\u7ed9\"fubar\"\u6765\u8f7d\u5165\"libfubar.so\"\u52a8\u6001\u94fe\u63a5\u5e93\u3002\n<\/li><\/ul>\n<ul><li>Provide a native function: jint JNI_OnLoad(JavaVM* vm, void* reserved) \n<\/li><li>\u63d0\u4f9b\u4e00\u4e2a\u672c\u5730\u51fd\u6570\uff1aint JNI_OnLoad(JavaVM* vm, void* reserved) \u6765\u5b9e\u73b0\u3002\n<\/li><\/ul>\n<ul><li>In JNI_OnLoad, register all of your native methods. You should declare the methods \"static\" so the names don't take up space in the symbol table on the device.\n<\/li><li>\u5728JNI_OnLoad\u51fd\u6570\u4e2d\u6ce8\u518c\u4f60\u6240\u6709\u7684\u672c\u5730\u65b9\u6cd5\u3002\u4f60\u53ef\u4ee5\u5c06\u6240\u6709\u7684\u65b9\u6cd5\u90fd\u58f0\u660e\u4e3a\u201cstatic\u201d\uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u5360\u7528\u8bbe\u5907\u4e2d\u7b26\u53f7\u5217\u8868\u4e0a\u7684\u7a7a\u95f4\u3002\n<\/li><\/ul>\n<p>The JNI_OnLoad function should look something like this if written in C++:\n\u5728C++\u4e2d\u4f60\u53ef\u4ee5\u53c2\u8003\u5982\u4e0b\u65b9\u5f0f\u6765\u6784\u9020JNI_OnLoad\u51fd\u6570\uff1a\n<\/p>\n<pre class=\"java\">&#160;\njint JNI_OnLoad<span style=\"color: #66cc66;\">&#40;<\/span>JavaVM* vm, <span style=\"color: #993333;\">void<\/span>* reserved<span style=\"color: #66cc66;\">&#41;<\/span>\n<span style=\"color: #66cc66;\">&#123;<\/span>\n    JNIEnv* env;\n    <span style=\"color: #b1b100;\">if<\/span> <span style=\"color: #66cc66;\">&#40;<\/span>vm-&gt;GetEnv<span style=\"color: #66cc66;\">&#40;<\/span>reinterpret_cast&lt;void**&gt;<span style=\"color: #66cc66;\">&#40;<\/span>&amp;env<span style=\"color: #66cc66;\">&#41;<\/span>, JNI_VERSION_1_6<span style=\"color: #66cc66;\">&#41;<\/span>&#160;!= JNI_OK<span style=\"color: #66cc66;\">&#41;<\/span> <span style=\"color: #66cc66;\">&#123;<\/span>\n        <span style=\"color: #000000; font-weight: bold;\">return<\/span> <span style=\"color: #cc66cc;\">-1<\/span>;\n    <span style=\"color: #66cc66;\">&#125;<\/span>\n&#160;\n    <span style=\"color: #808080; font-style: italic;\">\/\/ Get jclass with env-&gt;FindClass.<\/span>\n    <span style=\"color: #808080; font-style: italic;\">\/\/ Register methods with env-&gt;RegisterNatives.<\/span>\n&#160;\n    <span style=\"color: #000000; font-weight: bold;\">return<\/span> JNI_VERSION_1_6;\n<span style=\"color: #66cc66;\">&#125;<\/span>\n&#160;<\/pre>\n<p>You can also call System.load with the full path name of the shared library. For Android apps, you may find it useful to get the full path to the application's private data storage area from the context object.\n<\/p><p>\u4f60\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5171\u4eab\u5e93\u7684\u5b8c\u6574\u8def\u5f84\u6765\u8c03\u7528System.load\u3002\u5728Android\u7684\u5e94\u7528\u8f6f\u4ef6\u4e2d\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u5728\u5bf9\u8c61\u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u901a\u8fc7\u83b7\u53d6\u5b8c\u6574\u8def\u5f84\u6765\u5171\u4eab\u5e94\u7528\u7684\u79c1\u6709\u6570\u636e\u5b58\u50a8\u7a7a\u95f4\u662f\u975e\u5e38\u6709\u7528\u7684\u65b9\u6cd5\u3002\n<\/p><p>This is the recommended approach, but not the only approach. Explicit registration is not required, nor is it necessary that you provide a JNI_OnLoad function. You can instead use \"discovery\" of native methods that are named in a specific way (see <a rel=\"nofollow\" target=\"_blank\" class=\"external text\" href=\"http:\/\/java.sun.com\/javase\/6\/docs\/technotes\/guides\/jni\/spec\/design.html#wp615\">the JNI spec<\/a> for details), though this is less desirable because if a method signature is wrong you won't know about it until the first time the method is actually used.\n<\/p><p>\u4ee5\u4e0a\u662f\u63a8\u8350\u7684\u65b9\u6cd5\uff0c\u4f46\u5e76\u4e0d\u662f\u552f\u4e00\u65b9\u6cd5\u3002\u4f8b\u5982\uff0c\u660e\u6587\u6ce8\u518c\u5e76\u4e0d\u662f\u5fc5\u8981\u7684\u73af\u8282\u540c\u6837\uff0cJNI_OnLoad\u51fd\u6570\u7684\u8bbe\u7f6e\u4e5f\u4e0d\u662f\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u5bf9\u672c\u5730\u4ee3\u7801\u505a\u7279\u6b8a\u547d\u540d\uff08\u53c2\u8003the JNI spec\u8fd9\u4e00\u7ae0\u7684\u7ec6\u8282\uff09\u6765\u624b\u52a8\u201c\u5bfb\u627e\u201d\u5b83\u4eec\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u5e76\u4e0d\u662f\u90a3\u4e48\u8ba9\u4eba\u6ee1\u610f\uff0c\u56e0\u4e3a\u5982\u679c\u4f60\u5728\u67d0\u4e2a\u65b9\u6cd5\u7684\u6807\u8bb0\u4e0a\u5982\u679c\u51fa\u4e86\u9519\uff0c\u9664\u975e\u5728\u7b2c\u4e00\u65f6\u95f4\u8fd9\u4e2a\u65b9\u6cd5\u5c31\u88ab\u8c03\u7528\uff0c\u5426\u5219\u4f60\u5e76\u5c06\u4e0d\u4f1a\u610f\u8bc6\u5230\u5b83\u6709\u95ee\u9898\u3002\n<\/p><p>One other note about JNI_OnLoad: any FindClass calls you make from there will happen in the context of the class loader that was used to load the shared library. Normally FindClass uses the loader associated with the method at the top of the interpreted stack, or if there isn't one (because the thread was just attached) it uses the \"system\" class loader. This makes JNI_OnLoad a convenient place to look up and cache class object references.\n<\/p><p>\u5173\u4e8eJNI_OnLoad\u7684\u5176\u4ed6\u5907\u6ce8\uff1a\u4f60\u5728\u4e0a\u6587\u4e2d\u6240\u8c03\u7528\u7684FindClass \u51fd\u6570\u90fd\u53ef\u4ee5\u5728\u5171\u4eab\u5e93\u7684\u7c7b\u88c5\u8f7d\u5668\u4e2d\u5f97\u5230\u3002\u901a\u5e38\u6765\u8bf4\uff0cFindClass\u4f1a\u4f7f\u7528\u76f8\u5173\u65b9\u6cd5\u7684\u88c5\u8f7d\u5668\u6765\u5206\u6790\u6808\u9876\u6570\u636e\uff0c\u4f46\u5982\u679c\u6ca1\u6709\u8fd9\u6837\u7684\u88c5\u8f7d\u5668\uff08\u6709\u53ef\u80fd\u662f\u5df2\u7ecf\u9644\u7740\u5230\u7ebf\u7a0b\u4e0a\u4e86\uff09\uff0c\u90a3\u4e48\u5b83\u4e5f\u4f1a\u4f7f\u7528\u201c\u7cfb\u7edf\u201d\u7684\u7c7b\u88c5\u8f7d\u5668\u3002\u8fd9\u6837\u505a\u4f7f\u5f97JNI_OnLoad\u5f88\u5bb9\u6613\u88ab\u627e\u5230\uff0c\u800c\u4e14\u4e5f\u80fd\u7f13\u5b58\u7c7b\u5bf9\u8c61\u7684\u5f15\u7528\u3002\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"64-bit_Considerations-64-bit_.E7.8E.AF.E5.A2.83.E6.B3.A8.E6.84.8F.E4.BA.8B.E9.A1.B9\">64-bit Considerations-64-bit \u73af\u5883\u6ce8\u610f\u4e8b\u9879<\/span><\/h2>\n<p>Android is currently expected to run on 32-bit platforms. In theory it could be built for a 64-bit system, but that is not a goal at this time. For the most part this isn't something that you will need to worry about when interacting with native code, but it becomes significant if you plan to store pointers to native structures in integer fields in an object. To support architectures that use 64-bit pointers, you need to stash your native pointers in a long field rather than an int. \n<\/p><p>Android\u5f53\u524d\u591a\u8fd0\u884c\u4e8e32\u4f4d\u5e73\u53f0\u73af\u5883\u4e2d\u3002\u7406\u8bba\u4e0a\u6765\u8bf4\uff0c\u5b83\u540c\u6837\u4e5f\u80fd\u7f16\u8bd1\u621064\u4f4d\u7248\u672c\uff0c\u4f46\u8fd9\u5e76\u4e0d\u662f\u6700\u7ec8\u7684\u89e3\u51b3\u65b9\u6848\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u5f53\u4f60\u4f7f\u7528\u672c\u5730\u4ee3\u7801\u7684\u65f6\u5019\uff0c\u4f60\u5e76\u4e0d\u9700\u8981\u62c5\u5fc364\u4f4d\u7684\u7248\u672c\u95ee\u9898\u3002\u4f46\u662f\uff0c\u5047\u5982\u4f60\u6253\u7b97\u5728\u67d0\u4e2a\u5bf9\u8c61\u4e2d\u7684integer\u53d8\u91cf\u7684\u672c\u5730\u7ed3\u6784\u4f53\u4e2d\u5b58\u50a8\u6307\u9488\uff0c\u90a3\u4e4864\u4f4d\u7248\u672c\u5c31\u4f1a\u53d8\u6210\u4e3a\u5f88\u5927\u7684\u9ebb\u70e6\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u80fd\u591f\u572864\u4f4d\u67b6\u6784\u4e0b\u4f7f\u7528\u6307\u9488\uff0c\u4f60\u5fc5\u987b\u5c06\u4f60\u7684\u672c\u5730\u6307\u9488\u5b58\u50a8\u4e3along\u5f62\u800c\u975eint\u578b\u3002\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"Unsupported_Features.2FBackwards_Compatibility-.E4.B8.8D.E6.94.AF.E6.8C.81.E7.9A.84.E7.89.B9.E6.80.A7.2F.E5.90.91.E5.89.8D.E5.85.BC.E5.AE.B9.E6.80.A7\">Unsupported Features\/Backwards Compatibility-\u4e0d\u652f\u6301\u7684\u7279\u6027\/\u5411\u524d\u517c\u5bb9\u6027<\/span><\/h2>\n<p>All JNI 1.6 features are supported, with the following exception:\n\u9664\u4e86\u4ee5\u4e0b\u60c5\u51b5\u5916\uff0c\u6240\u6709\u76841.6\u7248\u672c\u7684JNI\u7684\u7279\u6027\u90fd\u88ab\u652f\u6301\uff1a\n<\/p>\n<ul><li>DefineClass is not implemented. Android does not use Java bytecodes or class files, so passing in binary class data doesn't work.\n<\/li><li>DefineClass\u65b9\u6cd5\u8fd8\u6ca1\u6709\u88ab\u5b9e\u73b0\u3002Android\u5f53\u524d\u6ca1\u6709\u4f7f\u7528JAVA\u6bd4\u7279\u7f16\u7801\u6216\u8005\u7c7b\uff0c\u6240\u4ee5\u662f\u65e0\u6cd5\u4f20\u9012\u7ed9\u5b83\u4eec\u4e8c\u8fdb\u5236\u7c7b\u6587\u4ef6\u7684\u3002\n<\/li><\/ul>\n<p>For backward compatibility with older Android releases, you may need to be aware of:\n\u5bf9\u65e9\u671fAndroid\u53d1\u5e03\u7248\u672c\u7684\u5411\u524d\u517c\u5bb9\u6027\uff0c\u4f60\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a\n<\/p>\n<ul><li>Dynamic lookup of native functions \n<\/li><li>\u52a8\u6001\u67e5\u627e\u672c\u5730\u51fd\u6570\n<\/li><\/ul>\n<dl><dd>Until Android 2.0 (Eclair), the '$' character was not properly converted to \"_00024\" during searches for method names. Working around this requires using explicit registration or moving the native methods out of inner classes. \n<\/dd><dd>\u5230Android2.0\uff08Eclair\uff09\u7248\u672c\u4e3a\u6b62\uff0c\u5728\u641c\u7d22\u65b9\u6cd5\u540d\u79f0\u65f6\uff0c\u2019$\u2019\u5b57\u7b26\u8fd8\u4e0d\u80fd\u591f\u88ab\u51c6\u786e\u8f6c\u6362\u4e3a\"_00024\"\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u660e\u6587\u6ce8\u518c\u6216\u8005\u662f\u5c06\u672c\u5730\u65b9\u6cd5\u4ece\u5185\u90e8\u7c7b\u4e2d\u79fb\u51fa\u3002\n<\/dd><\/dl>\n<ul><li>Detaching threads \n<\/li><li>\u5206\u79bb\u7ebf\u7a0b\n<\/li><\/ul>\n<dl><dd>Until Android 2.0 (Eclair), it was not possible to use a pthread_key_create destructor function to avoid the \"thread must be detached before exit\" check. (The runtime also uses a pthread key destructor function, so it'd be a race to see which gets called first.) \n<\/dd><dd>\u5230Android2.0\uff08\u00c9clair\uff09\u7248\u672c\u4e3a\u6b62\uff0c\u5229\u7528pthread_key_create\u6790\u6784\u51fd\u6570\u6765\u514d\u9664\u201c\u7ebf\u7a0b\u5728\u9000\u51fa\u65f6\u5148\u65ad\u5f00\u201d\u7684\u68c0\u67e5\u662f\u65e0\u6cd5\u505a\u5230\u7684\uff08\u8fd0\u884c\u65f6\u540c\u6837\u4f1a\u7528\u5230\u4e00\u4e2apthread\u5173\u952e\u6790\u6784\u51fd\u6570\uff0c\u6240\u4ee5\u770b\u8c01\u80fd\u66f4\u5feb\u7684\u53d6\u5f97\u8fd9\u4e2a\u51fd\u6570\uff0c\u8fd9\u662f\u4e2a\u6bd4\u8d5b\uff09\u3002\n<\/dd><\/dl>\n<ul><li>Weak global references \n<\/li><li>\u5f31\u5168\u5c40\u5f15\u7528\n<\/li><\/ul>\n<dl><dd>Until Android 2.2 (Froyo), weak global references were not implemented. Older versions will vigorously reject attempts to use them. You can use the Android platform version constants to test for support. \n<\/dd><\/dl>\n<dl><dd>\u5230Android2.2\uff08Froyo\uff09\u7248\u672c\u4e3a\u6b62\uff0c\u5f31\u5168\u5c40\u5f15\u7528\u8fd8\u4e0d\u80fd\u5b9e\u73b0\u3002\u65e7\u7248\u672c\u4e0d\u9057\u4f59\u529b\u7684\u62d2\u7edd\u4f7f\u7528\u8be5\u529f\u80fd\u3002\u4f60\u53ef\u4ee5\u7528android\u7684\u5e73\u53f0\u7248\u672c\u5e38\u6570\u6765\u6d4b\u8bd5\u662f\u5426\u652f\u6301\u8fd9\u4e2a\u529f\u80fd\u3002\n<\/dd><\/dl>\n<dl><dd>Until Android 4.0 (Ice Cream Sandwich), weak global references could only be passed to NewLocalRef, NewGlobalRef, and DeleteWeakGlobalRef. (The spec strongly encourages programmers to create hard references to weak globals before doing anything with them, so this should not be at all limiting.) \n<\/dd><\/dl>\n<dl><dd>\u800c\u5230Android4.0(Ice Cream Sandwich)\u7248\u672c\u4e3a\u6b62\uff0c\u5f31\u5168\u5c40\u5f15\u7528\u4e5f\u4ec5\u80fd\u5728NewLocalRef, NewGlobalRef, \u4ee5\u53caDeleteWeakGlobalRef\u51e0\u4e2a\u51fd\u6570\u4e2d\u5b9e\u73b0\uff08\u89c4\u8303\u4e2d\u9f13\u52b1\u7a0b\u5e8f\u5458\u5728\u5f15\u7528\u64cd\u4f5c\u4e4b\u524d\u521b\u9020\u5f3a\uff08hard\uff09\u5f15\u7528\uff0c\u4ece\u800c\u4ee3\u66ff\u5f31\u5168\u5c40\u5f15\u7528\uff0c\u56e0\u800c\u5f31\u5168\u5c40\u5f15\u7528\u5e76\u672a\u88ab\u5b8c\u5168\u9650\u5236\u4f7f\u7528\uff09\n<\/dd><\/dl>\n<dl><dd>From Android 4.0 (Ice Cream Sandwich) on, weak global references can be used like any other JNI references.\n<\/dd><\/dl>\n<dl><dd>\u4f46\u4eceAndroid4.0(Ice Cream Sandwich)\u7248\u672c\u8d77\uff0c\u5f31\u5168\u5c40\u5f15\u7528\u53ef\u4ee5\u5728\u9664\u4e86JNI\u5f15\u7528\u4e4b\u5916\u7684\u6240\u6709\u5730\u65b9\u4f7f\u7528\u4e86\u3002\n<\/dd><\/dl>\n<ul><li>Local references \n<\/li><li>\u5c40\u90e8\u5f15\u7528\n<\/li><\/ul>\n<dl><dd>Until Android 4.0 (Ice Cream Sandwich), local references were actually direct pointers. Ice Cream Sandwich added the indirection necessary to support better garbage collectors, but this means that lots of JNI bugs are undetectable on older releases. See JNI Local Reference Changes in ICS for more details. \n<\/dd><\/dl>\n<dl><dd>\u5230Android 4.0 (Ice Cream Sandwich)\u7248\u672c\u4e3a\u6b62\uff0c\u6240\u8c13\u7684\u672c\u5730\u5f15\u7528\u90fd\u662f\u6307\u76f4\u63a5\u6307\u9488\u3002Ice Cream Sandwich\u7248\u672c\u4e3a\u4e86\u66f4\u597d\u8fdb\u884c\u5783\u573e\u56de\u6536\uff0c\u6dfb\u52a0\u95f4\u63a5\u6307\u9488\u673a\u5236\uff0c\u4f46\u662f\u8fd9\u6837\u4e00\u6765\u4e5f\u5c31\u610f\u5473\u7740\u5927\u91cf\u7684JNI \u7684BUG\u5728\u65e7\u7248\u672c\u4e2d\u65e0\u6cd5\u88ab\u53d1\u73b0\u4e86\u3002\u5177\u4f53\u7684\u7ec6\u8282\u53ef\u4ee5\u53c2\u8003JNI Local Reference Changes in ICS\u4e00\u8282\u3002\n<\/dd><\/dl>\n<ul><li>Determining reference type with GetObjectRefType\n<\/li><li>\u901a\u8fc7GetObjectRefType\u786e\u8ba4\u5f15\u7528\u7c7b\u578b\n<\/li><\/ul>\n<dl><dd>Until Android 4.0 (Ice Cream Sandwich), as a consequence of the use of direct pointers (see above), it was impossible to implement GetObjectRefType correctly. Instead we used a heuristic that looked through the weak globals table, the arguments, the locals table, and the globals table in that order. The first time it found your direct pointer, it would report that your reference was of the type it happened to be examining. This meant, for example, that if you called GetObjectRefType on a global jclass that happened to be the same as the jclass passed as an implicit argument to your static native method, you'd get JNILocalRefType rather than JNIGlobalRefType. \n<\/dd><\/dl>\n<dl><dd>\u5230Android 4.0 (Ice Cream Sandwich)\u7248\u672c\u4e3a\u6b62\uff0c\u7531\u4e8e\u4e00\u76f4\u4f7f\u7528\u76f4\u63a5\u6307\u9488\u7684\u7f18\u6545\uff08\u89c1\u4e0a\uff09\uff0c\u5bfc\u81f4\u7cfb\u7edf\u65e0\u6cd5\u5b9e\u73b0GetObjectRefType\u65b9\u6cd5\u3002\u6211\u4eec\u53ea\u80fd\u63a2\u7d22\u6027\u7684\u4f7f\u7528\u5f31\u5168\u5c40\u5217\u8868\uff0c\u53c2\u6570\uff0c\u672c\u5730\u5217\u8868\u4ee5\u53ca\u5168\u5c40\u5217\u8868\u3002\u9996\u5148\u5b83\u4f1a\u627e\u5230\u4f60\u7684\u76f4\u63a5\u6307\u9488\uff0c\u7136\u540e\u62a5\u544a\u4f60\u7684\u5f15\u7528\u521a\u597d\u662f\u53ef\u4ee5\u88ab\u9a8c\u8bc1\u7684\u7c7b\u578b\u3002\u8fd9\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u4f60\u5728\u4e00\u4e2a\u5168\u5c40jclass\u4e2d\u8c03\u7528GetObjectRefType\u51fd\u6570\uff0c\u90a3\u4e48\u4e0ejclass\u5c06\u4e00\u4e2a\u9690\u5f62\u53c2\u6570\u4f20\u7ed9\u9759\u6001\u672c\u5730\u65b9\u6cd5\u7684\u6548\u679c\u662f\u4e00\u6837\u7684\uff0c\u6b64\u65f6\u4f60\u83b7\u5f97\u7684\u5176\u5b9e\u662fJNILocalRefType\u7684\u503c\uff0c\u800c\u975eJNIGlobalRefType\u7684\u3002\n<\/dd><\/dl>\n<h2> <span class=\"mw-headline\" id=\"FAQ:_Why_do_I_get_UnsatisfiedLinkError.3F-FAQ:_.E4.B8.BA.E4.BB.80.E4.B9.88.E6.88.91.E5.BE.97.E5.88.B0.E4.BA.86UnsatisfiedLinkError_.E9.94.99.E8.AF.AF.3F\">FAQ: Why do I get UnsatisfiedLinkError?-FAQ: \u4e3a\u4ec0\u4e48\u6211\u5f97\u5230\u4e86UnsatisfiedLinkError \u9519\u8bef?<\/span><\/h2>\n<p>When working on native code it's not uncommon to see a failure like this:\n\u5728\u672c\u5730\u4ee3\u7801\u73af\u5883\u4e0b\uff0c\u51fa\u73b0\u5982\u4e0b\u7684\u9519\u8bef\u662f\u5f88\u5e38\u89c1\u7684\uff1a\n<\/p>\n<pre class=\"java\">&#160;\njava.<span style=\"color: #006600;\">lang<\/span>.<a href=\"http:\/\/www.google.com\/search?hl=en&amp;q=allinurl%3AUnsatisfiedLinkError+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span style=\"color: #aaaadd; font-weight: bold;\">UnsatisfiedLinkError<\/span><\/a>: Library foo not found\n&#160;<\/pre>\n<p>In some cases it means what it says \u2014 the library wasn't found. In other cases the library exists but couldn't be opened by dlopen(3), and the details of the failure can be found in the exception's detail message.\n\u6709\u65f6\u5019\uff0c\u8fd9\u4e2a\u95ee\u9898\u7684\u539f\u56e0\u5c31\u50cf\u5b83\u7684\u5b57\u9762\u610f\u601d\u4e00\u6837\u2014\u2014\u8fd9\u4e2a\u5e93\u627e\u4e0d\u5230\u4e86\u3002\u800c\u8fd8\u6709\u4e9b\u60c5\u51b5\u662f\u8fd9\u4e2a\u5e93\u6587\u4ef6\u5b58\u5728\uff0c\u4f46\u662f\u4f60\u65e0\u6cd5\u901a\u8fc7dlopen(3)\u51fd\u6570\u6253\u5f00\u5b83\uff0c\u5173\u4e8e\u8be5\u9519\u8bef\u95ee\u9898\u7684\u7ec6\u8282\u4f60\u53ef\u4ee5\u5728\u5f02\u5e38\u7684\u8be6\u7ec6\u6d88\u606f\u4e2d\u8fdb\u884c\u67e5\u8be2\u3002\n<\/p><p>Common reasons why you might encounter \"library not found\" exceptions:\n\u5bf9\u4e8e\u4f60\u9047\u5230\u7684\u5f02\u5e38library not found\"\u5e38\u89c1\u7684\u539f\u56e0\u662f\uff1a\n<\/p>\n<ul><li>The library doesn't exist or isn't accessible to the app. Use adb shell ls -l &lt;path&gt; to check its presence and permissions. \n<\/li><li>\u8be5\u5e93\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u6216\u8005\u662f\u65e0\u6cd5\u88ab\u5e94\u7528\u6240\u8bbf\u95ee\u3002\u4f7f\u7528adb shell ls -l &lt;path&gt;\u547d\u4ee4\u6765\u68c0\u67e5\u5b83\u7684\u72b6\u6001\u4ee5\u53ca\u8bbf\u95ee\u6743\u9650\u3002\n<\/li><\/ul>\n<ul><li>The library wasn't built with the NDK. This can result in dependencies on functions or libraries that don't exist on the device. \n<\/li><li>\u8be5\u5e93\u6587\u4ef6\u8fd8\u6ca1\u6709\u88abNDK\u7f16\u8bd1\u51fa\u6765\u3002\u8fd9\u4f1a\u5bfc\u81f4\u4f9d\u8d56\u51fd\u6570\u6216\u8005\u5e93\u6587\u4ef6\u5728\u8bbe\u5907\u4e0a\u4e0d\u5b58\u5728\u3002\n<\/li><\/ul>\n<p>Another class of UnsatisfiedLinkError failures looks like:\n\u53e6\u5916\u4e00\u7c7b\u9519\u8befUnsatisfiedLinkError\u8868\u793a\u5982\u4e0b\uff1a\n<\/p>\n<pre class=\"java\">&#160;\njava.<span style=\"color: #006600;\">lang<\/span>.<a href=\"http:\/\/www.google.com\/search?hl=en&amp;q=allinurl%3AUnsatisfiedLinkError+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span style=\"color: #aaaadd; font-weight: bold;\">UnsatisfiedLinkError<\/span><\/a>: myfunc\n        at Foo.<span style=\"color: #006600;\">myfunc<\/span><span style=\"color: #66cc66;\">&#40;<\/span><span style=\"color: #000000; font-weight: bold;\">Native<\/span> <a href=\"http:\/\/www.google.com\/search?hl=en&amp;q=allinurl%3AMethod+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span style=\"color: #aaaadd; font-weight: bold;\">Method<\/span><\/a><span style=\"color: #66cc66;\">&#41;<\/span>\n        at Foo.<span style=\"color: #006600;\">main<\/span><span style=\"color: #66cc66;\">&#40;<\/span>Foo.<span style=\"color: #006600;\">java<\/span>:<span style=\"color: #cc66cc;\">10<\/span><span style=\"color: #66cc66;\">&#41;<\/span>\n&#160;<\/pre>\n<p>In logcat, you'll see:\n\u5728logcat\u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\uff1a\n<\/p>\n<pre>\nW\/dalvikvm(  880): No implementation found for native LFoo;.myfunc ()V\n<\/pre>\n<p>This means that the runtime tried to find a matching method but was unsuccessful. Some common reasons for this are:\n\u8fd9\u662f\u6307\u8fd0\u884c\u65f6\u5c1d\u8bd5\u53bb\u5bfb\u627e\u4e00\u4e2a\u5339\u914d\u7684\u65b9\u6cd5\u4f46\u662f\u5931\u8d25\u4e86\u3002\u8fd9\u4e2a\u95ee\u9898\u7684\u539f\u56e0\u6709\u53ef\u80fd\u662f\uff1a\n<\/p>\n<ul><li>The library isn't getting loaded. Check the logcat output for messages about library loading. \n<\/li><li>\u8be5\u5e93\u6587\u4ef6\u65e0\u6cd5\u88ab\u8f7d\u5165\u3002\u8bf7\u68c0\u67e5\u5e93\u6587\u4ef6\u8f7d\u5165\u8fc7\u7a0b\u4e2d\u7684logcat\u8f93\u51fa\u6d88\u606f\u3002\n<\/li><\/ul>\n<ul><li>The method isn't being found due to a name or signature mismatch. This is commonly caused by: \n<\/li><li>\u7531\u4e8e\u65b9\u6cd5\u7684\u540d\u79f0\u6216\u8005\u662f\u65b9\u6cd5\u7684\u7b7e\u540d\u95ee\u9898\uff0c\u5bfc\u81f4\u8be5\u65b9\u6cd5\u65e0\u6cd5\u88ab\u627e\u5230\u3002\u8fd9\u79cd\u60c5\u51b5\u7ecf\u5e38\u662f\u4ee5\u4e0b\u95ee\u9898\u5bfc\u81f4\u7684\uff1a\n<\/li><\/ul>\n<dl><dd><ul><li>For lazy method lookup, failing to declare C++ functions with extern \"C\" and appropriate visibility (JNIEXPORT). Note that prior to Ice Cream Sandwich, the JNIEXPORT macro was incorrect, so using a new GCC with an old jni.h won't work. You can use arm-eabi-nm to see the symbols as they appear in the library; if they look mangled (something like _Z15Java_Foo_myfuncP7_JNIEnvP7_jclass rather than Java_Foo_myfunc), or if the symbol type is a lowercase 't' rather than an uppercase 'T', then you need to adjust the declaration. \n<\/li><li>\u5bf9\u4e8e\u60f0\u6027\u5bfb\u627e\u65b9\u6cd5\uff0c\u672a\u80fd\u5728C++\u51fd\u6570\u524d\u52a0\u5165\u201dC\u201d\u7684\u58f0\u660e\u4ee5\u53ca\u8bbe\u7f6e\u5408\u9002\u7684\u8bbf\u95ee\u6743\u9650\u4f1a\u5bfc\u81f4\u8fd9\u4e2a\u95ee\u9898\uff08JNIEXPORT\u5b8f\uff09\u3002\u6ce8\u610f\u5728\u65e9\u4e8eIce Cream Sandwich\u7684\u7248\u672c\u4e2d\uff0c\u5b8fJNIEXPORT\u662f\u4e0d\u5b58\u5728\u7684\uff0c\u56e0\u6b64\u5982\u679c\u5728\u65b0\u7248\u672c\u7684GCC\u7f16\u8bd1\u5668\u4e2d\u7f16\u8bd1\u8001\u7248\u672c\u7684jni.h\u6587\u4ef6\u4f1a\u5931\u8d25\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7arm-eabi-nm\u6765\u67e5\u770b\u5e93\u6587\u4ef6\u4e2d\u662f\u5426\u5b58\u5728\u4e0a\u8ff0\u6587\u4ef6\u7b26\uff1b\u5982\u679c\u8fd9\u4e9b\u6587\u4ef6\u7b26\u770b\u8d77\u6765\u6df7\u4e71\u4e0d\u582a\uff08\u6bd4\u5982\u8bf4\u7c7b\u4f3c_Z15Java_Foo_myfuncP7_JNIEnvP7_jclass\uff0c\u800c\u4e0d\u662f\u6807\u51c6\u7684Java_Foo_myfunc\uff09\uff0c\u6216\u8005\uff0c\u5982\u679c\u8fd9\u4e9b\u6587\u4ef6\u7b26\u7684\u7c7b\u578b\uff08type\uff09\u90fd\u7528\u5c0f\u5199\u5b57\u6bcd\u2018t\u2019\u6765\u66ff\u4ee3\u5927\u5199\u5b57\u6bcd\u2019T\u2019\uff0c\u90a3\u4e48\u4f60\u9700\u8981\u8c03\u6574\u58f0\u660e\u90e8\u5206\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\n<\/li><\/ul>\n<\/dd><\/dl>\n<dl><dd><ul><li>For explicit registration, minor errors when entering the method signature. Make sure that what you're passing to the registration call matches the signature in the log file. Remember that 'B' is byte and 'Z' is boolean. Class name components in signatures start with 'L', end with ';', use '\/' to separate package\/class names, and use '$' to separate inner-class names (Ljava\/util\/Map$Entry;, say). \n<\/li><li>\u5728\u660e\u6587\u6ce8\u518c\u4e2d\uff0c\u5728\u8c03\u7528\u65b9\u6cd5\u7b7e\u540d\u73af\u8282\u51fa\u73b0\u7ea7\u522b\u4e3aminor\u7684\u9519\u8bef\u3002\u8bf7\u786e\u8ba4\u4f60\u4f20\u9012\u7ed9\u6ce8\u518c\u51fd\u6570\u7684\u7b7e\u540d\u4e0elog\u6587\u4ef6\u4e2d\u7684\u9700\u8981\u4e00\u81f4\u3002\u5207\u8bb0\u2019B\u2019\u6307\u7684\u662f\u6bd4\u7279\uff0c\u800c\u2019Z\u2019\u6307\u7684\u662f\u5e03\u5c14\u503c\u3002\u7b7e\u540d\u4e2d\u7684\u7c7b\u6587\u4ef6\u540d\u9700\u8981\u4ee5\u2019L\u2019\u5f00\u5934\uff0c\u4ee5\u2019;\u2019\u7ed3\u5c3e\uff0c\u7528\u2019\/\u2019\u6765\u5206\u683c\u5305\u548c\u7c7b\u540d\uff0c\u4f7f\u7528\u2019$\u2019\u6765\u58f0\u660e\u4e00\u4e2a\u5185\u90e8\u7c7b\u540d\uff08\u6bd4\u5982\u8bf4Ljava\/util\/Map$Entry\uff09\u3002\n<\/li><\/ul>\n<\/dd><\/dl>\n<p>Using javah to automatically generate JNI headers may help avoid some problems. \n\u5982\u679c\u4f7f\u7528javah\u5de5\u5177\u6765\u81ea\u52a8\u751f\u6210JNI\u5934\u6587\u4ef6\uff0c\u80fd\u907f\u514d\u5f88\u591a\u9ebb\u70e6\u3002\n<\/p>\n<h2> <span class=\"mw-headline\" id=\"FAQ:_Why_didn.27t_FindClass_find_my_class.3F-FAQ:_.E4.B8.BA.E4.BB.80.E4.B9.88.E6.88.91.E7.9A.84.E7.B1.BB.E6.96.87.E4.BB.B6.E4.B8.AD.E6.89.BE.E4.B8.8D.E5.88.B0FindClass.3F\">FAQ: Why didn't FindClass find my class?-FAQ: \u4e3a\u4ec0\u4e48\u6211\u7684\u7c7b\u6587\u4ef6\u4e2d\u627e\u4e0d\u5230FindClass?<\/span><\/h2>\n<p>Make sure that the class name string has the correct format. JNI class names start with the package name and are separated with slashes, such as java\/lang\/String. If you're looking up an array class, you need to start with the appropriate number of square brackets and must also wrap the class with 'L' and ';', so a one-dimensional array of String would be [Ljava\/lang\/String;.\n<\/p><p>\u8bf7\u786e\u8ba4\u4f60\u7684\u7c7b\u6587\u4ef6\u540d\u79f0\u683c\u5f0f\u662f\u5426\u6b63\u786e\u3002JNI\u7684\u7c7b\u540d\u7684\u683c\u5f0f\u662f\u4ece\u6240\u5728\u5305\u7684\u5305\u540d\u5f00\u59cb\uff0c\u4ee5\u5206\u9694\u7b26\u533a\u5206\uff0c\u6bd4\u5982java\/lang\/String\u3002\u5982\u679c\u4f60\u9700\u8981\u67e5\u627e\u4e00\u4e2a\u6570\u7ec4\u7c7b\uff0c\u4f60\u5f97\u4ee5\u9002\u5f53\u6570\u76ee\u7684\u65b9\u62ec\u53f7\uff08[\uff09\u4f5c\u4e3a\u5f00\u59cb\uff0c\u7136\u540e\u4ee5\u2019L\u2019\u5f00\u5934\uff0c\u2019;\u2019\u7ed3\u5c3e\u4f5c\u4e3a\u6587\u4ef6\u540d\u79f0\uff0c\u4ee5\u4e00\u4e2a\u4e00\u4f4d\u6570\u7ec4\u4e3a\u4f8b\uff0c\u5b83\u7684\u540d\u79f0\u5e94\u8be5\u662f[Ljava\/lang\/String;\u3002\n<\/p><p>If the class name looks right, you could be running into a class loader issue. FindClass wants to start the class search in the class loader associated with your code. It examines the call stack, which will look something like: \n<\/p><p>\u5982\u679c\u7c7b\u7684\u540d\u79f0\u770b\u8d77\u6765\u6ca1\u6709\u8bbe\u7f6e\u9519\uff0c\u53ef\u80fd\u95ee\u9898\u51fa\u5728\u7c7b\u88c5\u8f7d\u5668\u4e0a\u3002FindClass\u65b9\u6cd5\u53ef\u4ee5\u5728\u4f60\u7684\u4ee3\u7801\u7684\u7c7b\u88c5\u8f7d\u5668\u4e2d\u627e\u5230\u8be5\u7c7b\u3002\u5b83\u4ee5\u5982\u4e0b\u65b9\u5f0f\u6765\u68c0\u67e5\u8c03\u7528\u5806\u6808\uff1a\n<\/p>\n<pre class=\"java\">&#160;\n Foo.<span style=\"color: #006600;\">myfunc<\/span><span style=\"color: #66cc66;\">&#40;<\/span><span style=\"color: #000000; font-weight: bold;\">Native<\/span> <a href=\"http:\/\/www.google.com\/search?hl=en&amp;q=allinurl%3AMethod+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span style=\"color: #aaaadd; font-weight: bold;\">Method<\/span><\/a><span style=\"color: #66cc66;\">&#41;<\/span>\n    Foo.<span style=\"color: #006600;\">main<\/span><span style=\"color: #66cc66;\">&#40;<\/span>Foo.<span style=\"color: #006600;\">java<\/span>:<span style=\"color: #cc66cc;\">10<\/span><span style=\"color: #66cc66;\">&#41;<\/span>\n    dalvik.<span style=\"color: #006600;\">system<\/span>.<span style=\"color: #006600;\">NativeStart<\/span>.<span style=\"color: #006600;\">main<\/span><span style=\"color: #66cc66;\">&#40;<\/span><span style=\"color: #000000; font-weight: bold;\">Native<\/span> <a href=\"http:\/\/www.google.com\/search?hl=en&amp;q=allinurl%3AMethod+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky\"><span style=\"color: #aaaadd; font-weight: bold;\">Method<\/span><\/a><span style=\"color: #66cc66;\">&#41;<\/span>\n&#160;<\/pre>\n<p>The topmost method is Foo.myfunc. FindClass finds the ClassLoader object associated with the Foo class and uses that.\n<\/p><p>\u6392\u5728\u9996\u4f4d\u7684\u65b9\u6cd5\u662fFoo.myfunc\u3002FindClass\u65b9\u6cd5\u627e\u5230Foo\u7c7b\u7684\u7c7b\u88c5\u8f7d\u5668\u5e76\u4f7f\u7528\u5b83\u3002\n<\/p><p>This usually does what you want. You can get into trouble if you create a thread yourself (perhaps by calling pthread_create and then attaching it with AttachCurrentThread). Now the stack trace looks like this:\n<\/p><p>\u8fd9\u6837\u505a\u53ef\u4ee5\u8fbe\u5230\u4f60\u7684\u76ee\u7684\u3002\u4f46\u5982\u679c\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u4f60\u5c31\u4f1a\u9677\u5165\u56f0\u5883\u4e4b\u4e2d\uff08\u53ef\u80fd\u662f\u901a\u8fc7\u8c03\u7528pthread_create\u65b9\u6cd5\uff0c\u7136\u540e\u5c06\u5176\u5f15\u5165AttachCurrentThread\u65b9\u6cd5\uff09\u3002\u6b64\u65f6\uff0c\u5806\u6808\u8ddf\u8e2a\u8868\u663e\u793a\u5982\u4e0b\uff1a\n<\/p>\n<pre>\ndalvik.system.NativeStart.run(Native Method)\n<\/pre>\n<p>The topmost method is NativeStart.run, which isn't part of your application. If you call FindClass from this thread, the JavaVM will start in the \"system\" class loader instead of the one associated with your application, so attempts to find app-specific classes will fail.\n<\/p><p>\u6392\u5728\u9996\u4f4d\u7684\u65b9\u6cd5\u662fNativeStart.run\uff0c\u4f46\u8be5\u65b9\u6cd5\u5e76\u4e0d\u5728\u4f60\u7684\u5e94\u7528\u4e2d\u3002\u5982\u679c\u4f60\u5728\u672c\u7ebf\u7a0b\u4e2d\u8c03\u7528FindClass\u65b9\u6cd5\uff0cJAVA\u865a\u62df\u673a\u5c06\u4f1a\u5728\u201dsystem\u201d\u7c7b\u88c5\u8f7d\u5668\u91cc\uff0c\u800c\u4e0d\u662f\u4ece\u4f60\u7684\u5e94\u7528\u4e2d\u542f\u52a8\uff0c\u6240\u4ee5\u6b64\u65f6\u4f60\u53bb\u4ece\u5e94\u7528\u4e2d\u53bb\u5bfb\u627e\u7279\u5b9a\u7c7b\u662f\u627e\u4e0d\u5230\u7684\u3002\n<\/p><p>There are a few ways to work around this:\n<\/p><p>\u4ee5\u4e0b\u7684\u65b9\u6cd5\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a\n<\/p>\n<ul><li>Do your FindClass lookups once, in JNI_OnLoad, and cache the class references for later use. Any FindClass calls made as part of executing JNI_OnLoad will use the class loader associated with the function that called System.loadLibrary (this is a special rule, provided to make library initialization more convenient). If your app code is loading the library, FindClass will use the correct class loader. \n<\/li><\/ul>\n<ul><li>\u4f60\u662f\u5426\u5728JNI_OnLoad\u51fd\u6570\u4e2d\u4ec5\u8c03\u7528\u4e86\u4e00\u6b21FindClass\uff0c\u5e76\u4e14\u4e3a\u4e86\u540e\u7eed\u7684\u4f7f\u7528\u5c06\u7c7b\u5f15\u7528\u7f13\u5b58\u3002\u4efb\u4f55\u4e00\u4e2aFindClass\u8c03\u7528\u90fd\u53ef\u4ee5\u88ab\u89c6\u4e3a\u6267\u884cJNI_OnLoad\u51fd\u6570\u7684\u4e00\u90e8\u5206\uff0c\u8fd9\u6837\u505a\u4f1a\u4f7f\u7528System.loadLibrary\u5e93\u7684\u7c7b\u88c5\u8f7d\u5668\u7684\u529f\u80fd\uff08\u8fd9\u662f\u4e00\u4e2a\u7279\u522b\u7684\u529f\u80fd\uff0c\u4e13\u95e8\u7528\u4e8e\u521d\u59cb\u5316\u5e93\u6587\u4ef6\uff0c\u4f7f\u5176\u66f4\u52a0\u65b9\u4fbf\uff09\u3002\u5982\u679c\u4f60\u7684\u5e94\u7528\u8c03\u7528\u4e86\u5e93\u6587\u4ef6\uff0c\u90a3\u4e48FindClass\u4f1a\u4f7f\u7528\u6b63\u786e\u7684\u7c7b\u88c5\u8f7d\u5668\u3002\n<\/li><\/ul>\n<ul><li>Pass an instance of the class into the functions that need it, by declaring your native method to take a Class argument and then passing Foo.class in. \n<\/li><\/ul>\n<ul><li>\u901a\u8fc7\u58f0\u660e\u4f60\u7684\u672c\u5730\u65b9\u6cd5\uff0c\u5c06\u4e00\u4e2a\u7c7b\u7684\u5b9e\u4f8b\u4f20\u9012\u7ed9\u9700\u8981\u5b83\u7684\u51fd\u6570\u4e2d\uff0c\u7136\u540e\u53ef\u4ee5\u5c06\u7c7b\u7684\u53c2\u6570\u4f20\u9012\u7ed9Foo.class\u3002\n<\/li><\/ul>\n<ul><li>Cache a reference to the ClassLoader object somewhere handy, and issue loadClass calls directly. This requires some effort. \n<\/li><\/ul>\n<ul><li>\u5c06\u5f15\u7528\u7f13\u5b58\u81f3ClassLoader\u7684\u5bf9\u8c61\u662f\u5f88\u65b9\u4fbf\u7684\uff0c\u800c\u4e14\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528loadClass\u65b9\u6cd5\u3002\u5f53\u7136\uff0c\u8fd9\u9700\u8981\u4e00\u5b9a\u7684\u5de5\u4f5c\u91cf\u3002\n<\/li><\/ul>\n<h2> <span class=\"mw-headline\" id=\"FAQ:_How_do_I_share_raw_data_with_native_code.3F-FAQ:_.E6.88.91.E6.80.8E.E6.A0.B7.E6.89.8D.E8.83.BD.E4.B8.8E.E6.9C.AC.E5.9C.B0.E4.BB.A3.E7.A0.81.E5.85.B1.E4.BA.AB.E5.8E.9F.E5.A7.8B.E6.95.B0.E6.8D.AE.3F\">FAQ: How do I share raw data with native code?-FAQ: \u6211\u600e\u6837\u624d\u80fd\u4e0e\u672c\u5730\u4ee3\u7801\u5171\u4eab\u539f\u59cb\u6570\u636e?<\/span><\/h2>\n<p>You may find yourself in a situation where you need to access a large buffer of raw data from both managed and native code. Common examples include manipulation of bitmaps or sound samples. There are two basic approaches.\n<\/p><p>\u5f53\u9700\u8981\u5728\u672c\u5730\u4ee3\u7801\u548c\u6258\u7ba1\u4ee3\u7801\u95f4\u76f4\u63a5\u4f20\u9012\u5927\u91cf\u7684\u539f\u59cb\u6570\u636e\u65f6\uff0c\u4f60\u4f1a\u9677\u5165\u9ebb\u70e6\u4e2d\u3002\u5e38\u89c1\u7684\u60c5\u51b5\u5305\u62ec\u5bf9\u4f4d\u56fe\u6216\u8005\u662f\u58f0\u97f3\u6837\u672c\u7684\u64cd\u4f5c\u3002\u8fd9\u6709\u4e24\u79cd\u57fa\u672c\u65b9\u6cd5\u6765\u5904\u7406\u4e0a\u8ff0\u95ee\u9898\uff1a\n<\/p><p>You can store the data in a byte[]. This allows very fast access from managed code. On the native side, however, you're not guaranteed to be able to access the data without having to copy it. In some implementations, GetByteArrayElements and GetPrimitiveArrayCritical will return actual pointers to the raw data in the managed heap, but in others it will allocate a buffer on the native heap and copy the data over.\n<\/p><p>\u4f60\u53ef\u4ee5\u901a\u8fc7byte[]\u6765\u5b58\u50a8\u6570\u636e\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u4ece\u6258\u7ba1\u4ee3\u7801\u4e2d\u5feb\u901f\u8bbf\u95ee\u6570\u636e\u6bb5\u3002\u800c\u5728\u672c\u5730\u4ee3\u7801\u4fa7\uff0c\u4f60\u4e0d\u80fd\u4fdd\u8bc1\u5982\u679c\u6ca1\u6709\u590d\u5236\u4ee3\u7801\u8fd8\u80fd\u591f\u6210\u529f\u7684\u8bbf\u95ee\u5b83\u3002\u5728\u67d0\u4e9b\u5b9e\u73b0\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7GetByteArrayElements\u4ee5\u53caGetPrimitiveArrayCritical\u51fd\u6570\u8fd4\u56de\u539f\u59cb\u6570\u636e\u5728\u6258\u7ba1\u5806\u4e2d\u7684\u6307\u9488\uff0c\u53e6\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4e5f\u53ef\u4ee5\u5728\u672c\u5730\u5806\u4e2d\u5206\u914d\u4e00\u6bb5\u7f13\u51b2\u533a\u7528\u6765\u590d\u5236\u6570\u636e\u3002\n<\/p><p>The alternative is to store the data in a direct byte buffer. These can be created with java.nio.ByteBuffer.allocateDirect, or the JNI NewDirectByteBuffer function. Unlike regular byte buffers, the storage is not allocated on the managed heap, and can always be accessed directly from native code (get the address with GetDirectBufferAddress). Depending on how direct byte buffer access is implemented, accessing the data from managed code can be very slow.\n<\/p><p>\u8fd8\u6709\u4e00\u4e2a\u65b9\u6cd5\uff0c\u5c06\u6570\u636e\u5b58\u50a8\u81f3\u76f4\u63a5\u6bd4\u7279\u7f13\u51b2\u533a\u4e2d\u3002\u7f13\u51b2\u533a\u53ef\u4ee5\u901a\u8fc7java.nio.ByteBuffer.allocateDirect\u6216\u8005\u662fJNI NewDirectByteBuffer\u51fd\u6570\u6765\u521b\u5efa\u3002\u4e0d\u540c\u4e8e\u4e00\u822c\u7684\u6bd4\u7279\u7f13\u51b2\u533a\uff0c\u8be5\u7f13\u51b2\u533a\u5e76\u4e0d\u4f1a\u7531\u6258\u7ba1\u5806\u6765\u5206\u914d\u5730\u5740\uff0c\u4e14\u53ef\u4ee5\u7531\u672c\u5730\u4ee3\u7801\u76f4\u63a5\u8bbf\u95ee\uff08\u901a\u8fc7GetDirectBufferAddress\u51fd\u6570\u5c31\u53ef\u4ee5\u76f4\u63a5\u83b7\u5f97\u8bbf\u95ee\u5730\u5740\uff09\u3002\u4f46\u8003\u8651\u76f4\u63a5\u6bd4\u7279\u7f13\u5b58\u8bbf\u95ee\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u4ece\u6258\u7ba1\u4ee3\u7801\u83b7\u53d6\u6570\u636e\u7684\u8fc7\u7a0b\u53ef\u80fd\u4f1a\u975e\u5e38\u7f13\u6162\u3002\n<\/p><p>The choice of which to use depends on two factors:\n<\/p><p>\u4e0b\u9762\u4e24\u4e2a\u56e0\u7d20\u51b3\u5b9a\u4f60\u600e\u4e48\u9009\u62e9\u5408\u9002\u7684\u65b9\u6cd5\uff1a\n<\/p><p>1.Will most of the data accesses happen from code written in Java or in C\/C++? \n<\/p><p>1.\u6570\u636e\u8bbf\u95ee\u90e8\u5206\u7684\u4ee3\u7801\u662f\u7531JAVA\u8fd8\u662fC\/C++\u5199\u7684\uff1f\n<\/p><p>2.If the data is eventually being passed to a system API, what form must it be in? (For example, if the data is eventually passed to a function that takes a byte[], doing processing in a direct ByteBuffer might be unwise.) \n<\/p><p>2.\u5982\u679c\u6570\u636e\u6700\u7ec8\u9700\u8981\u4f20\u9012\u7ed9\u7cfb\u7edf\u7684API\uff0c\u5b83\u9700\u8981\u88ab\u5305\u88c5\u4e3a\u4ec0\u4e48\u683c\u5f0f\uff08\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u6570\u636e\u6700\u7ec8\u9700\u8981\u4ee5byte[]\u7684\u683c\u5f0f\u4f20\u7ed9\u67d0\u4e2a\u51fd\u6570\uff0c\u5c06\u5b83\u5305\u88c5\u4e3aByteBuffer\u5c31\u4e0d\u5408\u9002\u4e86\uff09\uff1f\n<\/p>"}